<!doctype html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/output.css" />
    <link rel="stylesheet" href="/styles/rm.css" />
    <script type="module" src="/components/client-components.js"></script>
    <rm-head page-title="Pages"></rm-head>
  </head>
  <body class="bg-primary-50">
    <rm-default-container>
      <rm-nav-header class="block"></rm-nav-header>
      <main class="mt-4 w-full">
        <article>
          <div class="mx-auto max-w-3xl px-4">
            <div
              id="category-title"
              class="text-primary-800 mt-2 text-3xl font-bold tracking-tight capitalize"
            >
              Loading...
            </div>
            <div class="text-primary-500 mt-2 mb-6 text-sm">
              Browse our latest articles and updates
            </div>
          </div>
          <section>
            <div id="status-container" class="mx-auto mb-4 hidden max-w-3xl px-4"></div>
            <div id="pages-container" class="mx-auto flex max-w-3xl flex-col gap-3 px-4"></div>
            <div
              id="load-more-container"
              class="mx-auto mt-6 mb-8 hidden max-w-3xl px-4 text-center"
            >
              <rm-button id="btn-load-more" sm secondary>Show More</rm-button>
            </div>
          </section>
        </article>
      </main>
      <rm-footer></rm-footer>
    </rm-default-container>

    <!-- Markdown Editor Modal (rendered via JS when needed) -->
    <div id="editor-container"></div>

    <!-- Publish Confirmation Modal (rendered via JS when needed) -->
    <div id="publish-modal-container"></div>

    <script type="module">
      // ==========================================================================
      // STATE VARIABLES
      // ==========================================================================

      var allPages = []
      var visibleCount = 15
      var INCREMENT = 15

      // Authentication state
      var isAdmin = false
      var userEmail = null

      // Editor modal state
      var editorOpen = false
      var editorCategory = ''
      var editorSlug = ''
      var editorMode = 'view'

      // Publish modal state
      var publishModalOpen = false
      var publishSlug = ''
      var publishTitle = ''
      var isPublishing = false

      // Extract category from URL path
      var pathParts = window.location.pathname.split('/').filter(function (p) {
        return p
      })
      var category = pathParts[1] || ''

      // ==========================================================================
      // DATE UTILITIES
      // ==========================================================================

      /**
       * Format ISO 8601 date string to readable format
       * Handles: 2025-12-12T10:35:00-00:00 or 2025-12-12T00:00:00
       */
      function formatDate(isoString) {
        if (!isoString) return ''
        try {
          var d = new Date(isoString)
          if (isNaN(d.getTime())) return ''
          return d.toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
          })
        } catch (e) {
          return ''
        }
      }

      /**
       * Parse date string to timestamp for sorting
       * Returns 0 if date is invalid (sorts to end)
       */
      function getDateTimestamp(dateStr) {
        if (!dateStr) return 0
        try {
          var ts = new Date(dateStr).getTime()
          return isNaN(ts) ? 0 : ts
        } catch (e) {
          return 0
        }
      }

      // ==========================================================================
      // PAGE UTILITIES
      // ==========================================================================

      /**
       * Check if a page is marked as sticky
       * Front matter: sticky: true (or yes, y, 1)
       */
      function isSticky(page) {
        if (!page || !page.sticky) return false
        var val = String(page.sticky).toLowerCase().trim()
        return val === 'true' || val === 'yes' || val === 'y' || val === '1'
      }

      /**
       * Sort pages:
       * 1. Sticky pages first (sorted by created date, newest first)
       * 2. Non-sticky pages second (sorted by created date, newest first)
       */
      function sortPages(pages) {
        if (!Array.isArray(pages)) return []

        // Create a copy to avoid mutating original
        var sorted = pages.slice()

        sorted.sort(function (a, b) {
          var aSticky = isSticky(a)
          var bSticky = isSticky(b)

          // Sticky pages come first
          if (aSticky && !bSticky) return -1
          if (!aSticky && bSticky) return 1

          // Within same group, sort by created date (newest first)
          var dateA = getDateTimestamp(a.created)
          var dateB = getDateTimestamp(b.created)
          return dateB - dateA
        })

        return sorted
      }

      // ==========================================================================
      // AUTHENTICATION
      // ==========================================================================

      /**
       * Check current session and determine if user is admin
       * Uses direct fetch to better-auth session endpoint
       */
      async function checkSession() {
        try {
          const response = await fetch('/api/auth/get-session', {
            method: 'GET',
            credentials: 'include', // Important: include cookies for session
          })

          if (!response.ok) {
            isAdmin = false
            userEmail = null
            return
          }

          const data = await response.json()

          if (data && data.user) {
            isAdmin = data.user.role === 'admin'
            userEmail = data.user.email
          } else {
            isAdmin = false
            userEmail = null
          }
        } catch (err) {
          console.error('Session check failed:', err)
          isAdmin = false
          userEmail = null
        }
      }

      // ==========================================================================
      // EDITOR MODAL MANAGEMENT
      // ==========================================================================

      /**
       * Open the markdown editor modal
       * @param {string} slug - The page slug
       * @param {string} mode - 'view' or 'edit'
       */
      function openEditor(slug, mode) {
        editorOpen = true
        editorCategory = category
        editorSlug = slug
        editorMode = mode || 'view'
        renderEditor()
      }

      /**
       * Close the markdown editor modal
       */
      function closeEditor() {
        editorOpen = false
        editorCategory = ''
        editorSlug = ''
        editorMode = 'view'
        renderEditor()
      }

      /**
       * Handle save event from editor - refresh the page list
       */
      function handleEditorSaved(e) {
        console.log('File saved:', e.detail)
        // Optionally refresh the page list to reflect any title changes
        init()
      }

      /**
       * Render the editor modal (or clear it if closed)
       */
      function renderEditor() {
        var container = document.getElementById('editor-container')
        if (!editorOpen) {
          container.innerHTML = ''
          return
        }

        // Create the editor element
        container.innerHTML = `
          <rm-markdown-editor
            id="md-editor"
            category="${editorCategory}"
            slug="${editorSlug}"
            mode="${editorMode}"
          ></rm-markdown-editor>
        `

        // Get reference and set properties
        var editor = document.getElementById('md-editor')
        editor.isOpen = true
        editor.category = editorCategory
        editor.slug = editorSlug
        editor.mode = editorMode

        // Add event listeners
        editor.addEventListener('close', closeEditor)
        editor.addEventListener('saved', handleEditorSaved)
      }

      // ==========================================================================
      // PUBLISH MODAL MANAGEMENT
      // ==========================================================================

      /**
       * Open the publish confirmation modal
       * @param {string} slug - The page slug
       * @param {string} title - The page title for display
       */
      function openPublishModal(slug, title) {
        publishModalOpen = true
        publishSlug = slug
        publishTitle = title || slug
        isPublishing = false
        renderPublishModal()
      }

      /**
       * Close the publish modal
       */
      function closePublishModal() {
        publishModalOpen = false
        publishSlug = ''
        publishTitle = ''
        isPublishing = false
        renderPublishModal()
      }

      /**
       * Handle the publish confirmation
       * Fetches the markdown, updates front matter, saves back
       */
      async function confirmPublish() {
        if (isPublishing || !publishSlug) return

        isPublishing = true
        renderPublishModal()

        try {
          // 1. Fetch the current raw markdown
          const getResponse = await fetch(`/api/pages/raw/${category}/${publishSlug}`, {
            method: 'GET',
            credentials: 'include',
          })

          if (!getResponse.ok) {
            throw new Error('Failed to fetch page content')
          }

          const data = await getResponse.json()
          let content = data.content || ''

          // 2. Update the front matter to set published: y
          content = updateFrontMatterPublished(content)

          // 3. Save the updated content
          const putResponse = await fetch(`/api/pages/raw/${category}/${publishSlug}`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: content }),
          })

          if (!putResponse.ok) {
            throw new Error('Failed to save page')
          }

          // Success - close modal and refresh list
          closePublishModal()
          init()
        } catch (err) {
          console.error('Publish failed:', err)
          alert('Failed to publish: ' + err.message)
          isPublishing = false
          renderPublishModal()
        }
      }

      /**
       * Update the front matter to set published: y
       * Handles various cases: existing published line, no published line, no front matter
       */
      function updateFrontMatterPublished(content) {
        // Check if there's front matter
        const fmMatch = content.match(/^---\n([\s\S]*?)\n---/)

        if (!fmMatch) {
          // No front matter - add it
          return '---\npublished: y\n---\n' + content
        }

        const frontMatter = fmMatch[1]
        const afterFrontMatter = content.slice(fmMatch[0].length)

        // Check if published line exists
        if (/^published\s*:/m.test(frontMatter)) {
          // Replace existing published line
          const updatedFm = frontMatter.replace(/^published\s*:.*$/m, 'published: y')
          return '---\n' + updatedFm + '\n---' + afterFrontMatter
        } else {
          // Add published line to front matter
          return '---\n' + frontMatter + '\npublished: y\n---' + afterFrontMatter
        }
      }

      /**
       * Render the publish modal
       */
      function renderPublishModal() {
        var container = document.getElementById('publish-modal-container')

        if (!publishModalOpen) {
          container.innerHTML = ''
          return
        }

        container.innerHTML = `
          <div
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"
            onclick="window.closePublishModal()"
          >
            <div
              class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6"
              onclick="event.stopPropagation()"
            >
              <h3 class="text-lg font-bold text-primary-800 mb-2">Publish Page</h3>
              <p class="text-primary-600 text-sm mb-6">
                Set "<span class="font-medium">${publishTitle}</span>" to published?
              </p>
              <div class="flex justify-end gap-3">
                <button
                  onclick="window.closePublishModal()"
                  class="px-4 py-2 text-sm font-medium text-primary-600 border border-primary-200 rounded hover:bg-primary-50 transition-colors"
                  ${isPublishing ? 'disabled' : ''}
                >
                  Cancel
                </button>
                <button
                  onclick="window.confirmPublish()"
                  class="px-4 py-2 text-sm font-medium text-white bg-secondary-600 rounded hover:bg-secondary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                  ${isPublishing ? 'disabled' : ''}
                >
                  ${
                    isPublishing
                      ? `
                    <span class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                    Publishing...
                  `
                      : 'Yes, Publish'
                  }
                </button>
              </div>
            </div>
          </div>
        `
      }

      // ==========================================================================
      // INITIALIZATION
      // ==========================================================================

      /**
       * Initialize the page list
       */
      async function init() {
        if (!category) {
          document.getElementById('category-title').textContent = 'Category Not Found'
          return
        }

        // Set category title
        document.getElementById('category-title').textContent =
          category.charAt(0).toUpperCase() + category.slice(1)

        // Check authentication status first
        await checkSession()

        // Fetch page list
        fetch('/api/pages/list/' + category)
          .then(function (res) {
            if (!res.ok) throw new Error('Failed to fetch')
            return res.json()
          })
          .then(function (data) {
            allPages = data.pages || []

            // Sort: sticky first, then by date within each group
            allPages = sortPages(allPages)

            render()
          })
          .catch(function (err) {
            console.error('Error loading pages:', err)
            document.getElementById('pages-container').innerHTML =
              '<p class="text-red-600">Failed to load pages. Please try again.</p>'
          })
      }

      // ==========================================================================
      // RENDERING
      // ==========================================================================

      /**
       * Render the page list
       */
      function render() {
        var container = document.getElementById('pages-container')
        var loadMoreContainer = document.getElementById('load-more-container')

        container.innerHTML = ''

        // Show message if no pages
        if (!allPages || allPages.length === 0) {
          container.innerHTML = '<p class="text-primary-500">No pages found in this category.</p>'
          loadMoreContainer.classList.add('hidden')
          return
        }

        // Render visible pages
        var pagesToShow = allPages.slice(0, visibleCount)

        pagesToShow.forEach(function (page) {
          var article = document.createElement('div')
          article.className =
            'group relative bg-white p-4 rounded-md border border-primary-100 shadow-sm hover:shadow-md transition-all'

          // Private badge
          var privateBadge = page.private
            ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 border border-amber-200">Private</span>'
            : ''

          // Sticky indicator (pin icon)
          var stickyBadge = isSticky(page)
            ? '<span class="mr-2 text-primary-500" title="Pinned"><svg class="w-4 h-4 inline" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a3 3 0 015-2.236A3 3 0 0114.83 6H16a2 2 0 110 4h-5V9a1 1 0 10-2 0v1H4a2 2 0 110-4h1.17C5.06 5.687 5 5.35 5 5zm4 1V5a1 1 0 10-2 0v1h2zm3 0a1 1 0 10-2 0v1h2V6z" clip-rule="evenodd"/><path d="M9 11H3v5a2 2 0 002 2h4v-7zm2 7h4a2 2 0 002-2v-5h-6v7z"/></svg></span>'
            : ''

          // Format date
          var dateStr = formatDate(page.created)
          var dateHtml = dateStr
            ? '<span class="text-xs text-primary-400 font-mono">' + dateStr + '</span>'
            : ''

          // =======================================================================
          // ADMIN EDIT LINK - Only shown to admin users
          // Subtle text link style with conditional publish option
          // =======================================================================
          var adminEditButton = ''
          if (isAdmin) {
            // Check if page is not published (show publish link)
            // published can be 'y', 'n', or undefined
            var isPublished = page.published && page.published.toLowerCase() === 'y'
            var publishLink = ''

            if (!isPublished) {
              // Escape title for use in onclick - replace quotes
              var escapedTitle = (page.title || page.slug).replace(/'/g, "\\'").replace(/"/g, '\\"')
              publishLink = `
                <span class="text-primary-300">|</span>
                <button
                  onclick="window.openPublishModal('${page.slug}', '${escapedTitle}')"
                  class="hover:text-green-600 hover:underline transition-colors"
                  title="Publish this page"
                >publish</button>
              `
            }

            adminEditButton = `
              <span class="ml-2 text-xs text-primary-400" onclick="event.preventDefault(); event.stopPropagation();">
                <button
                  onclick="window.openPageEditor('${page.slug}', 'view')"
                  class="hover:text-primary-600 hover:underline transition-colors"
                  title="View raw markdown"
                >view</button>
                <span class="text-primary-300">|</span>
                <button
                  onclick="window.openPageEditor('${page.slug}', 'edit')"
                  class="hover:text-secondary-600 hover:underline transition-colors"
                  title="Edit markdown"
                >edit</button>
                ${publishLink}
              </span>
            `
          }

          article.innerHTML =
            '<a href="/pages/' +
            category +
            '/' +
            page.slug +
            '" class="block">' +
            '<div class="flex justify-between items-center gap-4">' +
            '<div class="flex-grow min-w-0">' +
            '<h2 class="text-lg font-bold text-primary-800 group-hover:text-primary-600 truncate leading-tight flex items-center flex-wrap">' +
            stickyBadge +
            '<span class="truncate">' +
            (page.title || 'Untitled') +
            '</span>' +
            privateBadge +
            adminEditButton +
            '</h2>' +
            '<p class="text-sm text-primary-600 mt-1 line-clamp-2">' +
            (page.summary || '') +
            '</p>' +
            '<div class="mt-2 hidden">' +
            dateHtml +
            ' use to debug date sort!</div>' +
            '</div>' +
            '<div class="hidden sm:flex items-center gap-1 text-secondary-600 font-semibold text-sm group-hover:text-secondary-700 transition-colors whitespace-nowrap pl-2">' +
            '<span>Read</span>' +
            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>' +
            '</svg>' +
            '</div>' +
            '</div>' +
            '</a>'

          container.appendChild(article)
        })

        // Show/hide load more button
        if (allPages.length > visibleCount) {
          loadMoreContainer.classList.remove('hidden')
        } else {
          loadMoreContainer.classList.add('hidden')
        }
      }

      // ==========================================================================
      // GLOBAL FUNCTION EXPORTS (for onclick handlers in HTML)
      // ==========================================================================

      // Expose editor open function globally for onclick handlers
      window.openPageEditor = openEditor

      // Expose publish modal functions globally
      window.openPublishModal = openPublishModal
      window.closePublishModal = closePublishModal
      window.confirmPublish = confirmPublish

      // ==========================================================================
      // EVENT LISTENERS
      // ==========================================================================

      // Load more button handler
      document.getElementById('btn-load-more').addEventListener('click', function () {
        visibleCount += INCREMENT
        render()
      })

      // ==========================================================================
      // START
      // ==========================================================================

      // Initialize on page load
      init()
    </script>
  </body>
</html>

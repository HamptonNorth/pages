<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="/styles/output.css" />
    <link rel="stylesheet" href="/styles/rm.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
    />

    <script type="module" src="/components/client-components.js"></script>
    <rm-head page-title="Loading..."></rm-head>

    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 100%;
        margin: 0 auto;
        padding: 1rem 0;
        background-color: transparent !important;
      }

      .code-wrapper {
        position: relative;
      }
      .copy-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        color: #4b5563;
        cursor: pointer;
        transition: all 0.2s;
        display: none;
      }
      .code-wrapper:hover .copy-btn {
        display: block;
      }
      .copy-btn:hover {
        background: #fff;
        color: #1f2937;
        border-color: #9ca3af;
      }
      .copy-btn.copied {
        background: #10b981;
        color: white;
        border-color: #10b981;
      }

      @media (max-width: 767px) {
        .markdown-body {
          padding: 15px 0;
        }
      }

      /* --- PRINT STYLES (Refined) --- */
      @media print {
        /* Hide UI elements */
        rm-nav-header,
            rm-footer,
            aside, /* Hides the entire sidebar tag */
            #sidebar-col,
            #top-back-link,
            #btn-print,
            .copy-btn,
            #mobile-menu-trigger {
          display: none !important;
        }

        /* Force Containers to Block/Full Width */
        body,
        html,
        rm-default-container,
        #layout-wrapper,
        main,
        article,
        .markdown-body {
          display: block !important;
          width: 100% !important;
          height: auto !important;
          margin: 0 !important;
          padding: 0 !important;
          overflow: visible !important;
          background-color: white !important;
          box-shadow: none !important;
          border: none !important;
        }

        /* Ensure Text is Black */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        p,
        li,
        span,
        div {
          color: black !important;
        }

        /* Fix Code Blocks clipping */
        pre {
          white-space: pre-wrap !important;
          word-wrap: break-word !important;
          border: 1px solid #ccc !important;
        }
      }
    </style>
  </head>
  <body class="bg-primary-50 flex min-h-screen flex-col">
    <rm-default-container class="flex grow flex-col">
      <rm-nav-header class="block shrink-0"></rm-nav-header>

      <div id="layout-wrapper" class="relative flex w-full grow flex-col items-start md:flex-row">
        <aside
          id="sidebar-col"
          class="border-primary-200 hidden w-full shrink-0 self-stretch border-r bg-gray-50/50 md:sticky md:top-0 md:h-auto md:min-h-[calc(100vh-64px)] md:w-56"
        >
          <div
            id="mobile-menu-trigger"
            class="border-primary-100 bg-primary-50 flex cursor-pointer items-center justify-between border-b p-4 md:hidden"
            onclick="toggleMobileMenu()"
          >
            <span class="text-primary-500 text-xs font-bold uppercase">Documentation Menu</span>
            <svg
              class="text-primary-500 h-4 w-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </div>

          <div class="hidden overflow-y-auto p-4 md:block" id="sidebar-content">
            <div class="mb-6">
              <a
                id="sidebar-back-link"
                href="#"
                class="group text-primary-500 hover:text-primary-700 flex items-center gap-2 text-xs font-bold tracking-wide uppercase"
              >
                <div
                  class="border-primary-200 group-hover:border-primary-400 flex h-6 w-6 items-center justify-center rounded-full border bg-white transition-colors"
                >
                  <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 19l-7-7m0 0l7-7m-7 7h18"
                    ></path>
                  </svg>
                </div>
                Back to list
              </a>
            </div>
            <nav id="nav-tree" class="flex flex-col gap-1 text-sm">
              <div class="animate-pulse space-y-2">
                <div class="bg-primary-100 h-4 w-3/4 rounded"></div>
                <div class="bg-primary-50 h-4 w-full rounded"></div>
              </div>
            </nav>
          </div>
        </aside>

        <main class="w-full min-w-0 grow bg-white pb-12">
          <article>
            <div class="border-primary-100 border-b px-6 pt-8 pb-4 md:px-12">
              <a
                id="top-back-link"
                href="#"
                class="text-primary-500 hover:text-primary-700 mb-4 inline-block text-sm font-medium"
                >&larr; Back to list</a
              >

              <div class="flex items-start justify-between gap-4">
                <h1
                  id="page-title"
                  class="text-primary-800 mb-3 text-3xl leading-tight font-bold tracking-tight md:text-4xl"
                >
                  Loading...
                </h1>

                <button
                  id="btn-print"
                  onclick="window.print()"
                  class="text-primary-500 hover:text-primary-700 border-primary-200 hover:bg-primary-50 mt-1 inline-flex items-center gap-1.5 rounded border bg-white px-3 py-1.5 text-sm font-medium shadow-sm transition-colors"
                  title="Print this page"
                >
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
                    ></path>
                  </svg>
                  <span>Print</span>
                </button>
              </div>

              <div class="text-primary-500 mt-2 flex flex-wrap items-center gap-4 text-sm">
                <span id="page-date" class="flex items-center gap-1 font-mono text-xs"></span>
                <span
                  id="private-badge"
                  class="hidden rounded-full border border-amber-200 bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-800"
                  >Private</span
                >
              </div>
            </div>

            <div class="mt-6 px-6 md:px-12">
              <div id="status-container" class="mb-4 hidden"></div>
              <div id="markdown-content" class="markdown-body">
                <div class="max-w-2xl animate-pulse space-y-4">
                  <div class="h-4 w-3/4 rounded bg-gray-200"></div>
                  <div class="h-4 w-full rounded bg-gray-200"></div>
                  <div class="h-4 w-5/6 rounded bg-gray-200"></div>
                  <div class="h-32 rounded bg-gray-100"></div>
                </div>
              </div>
            </div>
          </article>
        </main>
      </div>

      <rm-footer></rm-footer>
    </rm-default-container>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
      // Use DOMContentLoaded to ensure elements exist before script runs
      document.addEventListener('DOMContentLoaded', init)

      const pathParts = window.location.pathname.split('/').filter((p) => p)
      const category = pathParts.length >= 2 ? pathParts[1] : ''
      const slug = pathParts.length >= 3 ? pathParts[2] : ''

      // Elements (Declared globally but initialized/checked inside init)
      const sidebarCol = document.getElementById('sidebar-col')
      const navTree = document.getElementById('nav-tree')
      const sidebarBackLink = document.getElementById('sidebar-back-link')
      const topBackLink = document.getElementById('top-back-link')

      const titleEl = document.getElementById('page-title')
      const dateEl = document.getElementById('page-date')
      const contentEl = document.getElementById('markdown-content')
      const statusEl = document.getElementById('status-container')
      const privateBadge = document.getElementById('private-badge')
      const headEl = document.querySelector('rm-head')

      async function init() {
        if (!category || !slug) return showError('Invalid URL.')

        // Configure Back Links (Safe Check)
        if (category) {
          const listUrl = `/pages/${category}`
          if (sidebarBackLink) sidebarBackLink.href = listUrl
          if (topBackLink) {
            topBackLink.href = listUrl
            topBackLink.textContent = `â† Back to ${category}`
          }
        }

        // 1. Check Config for Sidebar
        let hasSidebar = false
        try {
          const cfgRes = await fetch('/api/pages-config')
          if (cfgRes.ok) {
            const categories = await cfgRes.json()
            const currentCat = categories.find((c) => c.name === category)
            if (currentCat && currentCat.sidebar) {
              hasSidebar = true
            }
          }
        } catch (e) {
          console.error('Config fetch error', e)
        }

        // 2. Adjust Layout
        if (hasSidebar) {
          if (sidebarCol) sidebarCol.classList.remove('hidden')
          if (topBackLink) topBackLink.classList.add('hidden')
          loadSidebarLinks()
        } else {
          if (sidebarCol) sidebarCol.remove()
          if (topBackLink) topBackLink.classList.remove('hidden')
        }

        // 3. Load Content
        await loadPageContent()
      }

      async function loadSidebarLinks() {
        if (!navTree) return
        try {
          const res = await fetch(`/api/pages/list/${category}`)
          if (!res.ok) return
          const data = await res.json()
          const pages = data.pages || []

          let html = ''
          pages.forEach((p) => {
            const isActive = p.slug === slug
            const baseClass =
              'block py-1.5 px-3 rounded text-sm transition-colors duration-200 leading-snug'
            const activeClass =
              'bg-white text-primary-700 font-bold shadow-sm ring-1 ring-primary-100'
            const inactiveClass = 'text-gray-600 hover:bg-white hover:text-primary-700'

            html += `
                        <a href="/pages/${category}/${p.slug}" class="${baseClass} ${isActive ? activeClass : inactiveClass}">
                           ${p.title || 'Untitled'}
                        </a>
                    `
          })
          navTree.innerHTML = html
        } catch (e) {
          navTree.innerHTML = `<div class="text-xs text-red-500">Failed to load menu</div>`
        }
      }

      async function loadPageContent() {
        try {
          const res = await fetch(`/api/pages/content/${category}/${slug}`)
          if (!res.ok) {
            if (res.status === 403) throw new Error('Access Denied.')
            if (res.status === 410) throw new Error('Content Expired.')
            if (res.status === 404) throw new Error('Page not found.')
            throw new Error('Error loading page.')
          }

          const data = await res.json()
          renderContent(data)
        } catch (error) {
          showError(error.message)
        }
      }

      function renderContent(data) {
        const { meta, html } = data

        if (titleEl) titleEl.textContent = meta.title || 'Untitled'
        if (headEl) headEl.setAttribute('page-title', meta.title)

        if (meta.created && dateEl) {
          const d = new Date(meta.created)
          if (!isNaN(d.getTime())) {
            dateEl.innerHTML = `
                        <svg class="w-4 h-4 text-primary-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        ${d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })}
                    `
          }
        }

        if (meta.private && privateBadge) privateBadge.classList.remove('hidden')

        if (contentEl) {
          contentEl.innerHTML = html
          contentEl.querySelectorAll('pre code').forEach((el) => {
            hljs.highlightElement(el)
          })
          addCopyButtons()
        }
      }

      function addCopyButtons() {
        if (!contentEl) return
        const codeBlocks = contentEl.querySelectorAll('pre')
        codeBlocks.forEach((pre) => {
          const wrapper = document.createElement('div')
          wrapper.className = 'code-wrapper'
          pre.parentNode.insertBefore(wrapper, pre)
          wrapper.appendChild(pre)

          const btn = document.createElement('button')
          btn.className = 'copy-btn'
          btn.textContent = 'Copy'

          btn.addEventListener('click', async () => {
            const code = pre.querySelector('code').innerText
            try {
              await navigator.clipboard.writeText(code)
              btn.textContent = 'Copied!'
              btn.classList.add('copied')
              setTimeout(() => {
                btn.textContent = 'Copy'
                btn.classList.remove('copied')
              }, 2000)
            } catch (err) {
              btn.textContent = 'Error'
            }
          })

          wrapper.appendChild(btn)
        })
      }

      function showError(msg) {
        if (titleEl) titleEl.textContent = 'Error'
        if (contentEl) contentEl.innerHTML = ''
        if (statusEl) {
          statusEl.classList.remove('hidden')
          statusEl.innerHTML = `<div class="bg-red-50 text-red-700 px-4 py-3 rounded border border-red-200">${msg}</div>`
        }
      }

      window.toggleMobileMenu = function () {
        const content = document.getElementById('sidebar-content')
        if (content) content.classList.toggle('hidden')
      }
    </script>
  </body>
</html>

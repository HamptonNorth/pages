<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/output.css" />
    <link rel="stylesheet" href="/styles/rm.css" />
    <script type="module" src="/components/client-components.js"></script>
    <rm-head page-title="Pages"></rm-head>
  </head>
  <body class="bg-primary-50">
    <rm-default-container>
      <rm-nav-header class="block"></rm-nav-header>

      <main class="mt-4 w-full">
        <article>
          <div class="mx-auto max-w-3xl px-4">
            <div
              id="category-title"
              class="text-primary-800 mt-2 text-3xl font-bold tracking-tight capitalize"
            >
              Loading...
            </div>
            <div class="text-primary-500 mt-2 mb-6 text-sm">
              Browse our latest articles and updates
            </div>
          </div>

          <section>
            <div id="status-container" class="mx-auto mb-4 hidden max-w-3xl px-4"></div>

            <div id="pages-container" class="mx-auto flex max-w-3xl flex-col gap-3 px-4">
              <div class="flex animate-pulse flex-col gap-2">
                <div class="bg-primary-100 h-5 w-1/3 rounded"></div>
                <div class="bg-primary-50 h-3 w-2/3 rounded"></div>
              </div>
            </div>

            <div
              id="load-more-container"
              class="mx-auto mt-6 mb-8 hidden max-w-3xl px-4 text-center"
            >
              <rm-button id="btn-load-more" sm secondary>Show More</rm-button>
            </div>
          </section>
        </article>
      </main>

      <rm-footer></rm-footer>
    </rm-default-container>

    <script>
      // State
      let allPages = []
      let visibleCount = 25
      const INCREMENT = 25

      const pathParts = window.location.pathname.split('/').filter((p) => p)
      const category = pathParts.length >= 2 ? pathParts[1] : ''

      const container = document.getElementById('pages-container')
      const loadMoreBtn = document.getElementById('btn-load-more')
      const loadMoreContainer = document.getElementById('load-more-container')
      const titleEl = document.getElementById('category-title')
      const statusEl = document.getElementById('status-container')
      const headEl = document.querySelector('rm-head')

      async function init() {
        if (!category) {
          titleEl.textContent = 'Category Not Found'
          showStatus('Invalid URL structure.', 'error')
          container.innerHTML = ''
          return
        }

        const displayCategory = category.charAt(0).toUpperCase() + category.slice(1)
        titleEl.textContent = displayCategory
        if (headEl) headEl.setAttribute('page-title', `${displayCategory} - Pages`)

        try {
          const res = await fetch(`/api/pages/list/${category}`)
          if (!res.ok) throw new Error('Failed to fetch pages')

          const data = await res.json()
          allPages = data.pages || []
          render()
        } catch (err) {
          console.error(err)
          container.innerHTML = ''
          showStatus('Unable to load pages. Please try again later.', 'error')
        }
      }

      function formatDate(isoString) {
        if (!isoString) return ''
        const d = new Date(isoString)
        return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })
      }

      function showStatus(msg, type) {
        statusEl.classList.remove('hidden')
        statusEl.innerHTML = `<div class="p-3 rounded text-sm ${type === 'error' ? 'bg-red-50 text-red-700' : 'bg-primary-100 text-primary-700'}">${msg}</div>`
      }

      function render() {
        container.innerHTML = ''

        if (allPages.length === 0) {
          showStatus('No published pages found in this category.', 'info')
          return
        }

        const toShow = allPages.slice(0, visibleCount)

        toShow.forEach((page) => {
          const linkUrl = `/pages/${category}/${page.slug}`
          const article = document.createElement('div')

          article.className = `
            group relative bg-white p-4 rounded-md border border-primary-100 shadow-sm
            hover:shadow-md hover:border-primary-300 transition-all duration-200
          `

          let badges = ''
          if (page.private) {
            // Reverted to Pill style: rounded-full, distinct padding
            badges += `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 border border-amber-200">Private</span>`
          }

          const dateStr = formatDate(page.created)

          article.innerHTML = `
            <a href="${linkUrl}" class="block focus:outline-none">
                <div class="flex justify-between items-center gap-4">
                    <div class="flex-grow min-w-0">
                        <h2 class="text-lg font-bold text-primary-800 group-hover:text-primary-600 truncate leading-tight flex items-center">
                            ${page.title || 'Untitled'}
                            ${badges}
                        </h2>

                        <p class="mt-1 text-sm text-primary-600 line-clamp-2">
                            ${page.summary || ''}
                        </p>

                        <div class="mt-2 flex items-center gap-3 text-xs text-primary-400 font-mono">
                           ${dateStr ? `<span>${dateStr}</span>` : ''}
                        </div>
                    </div>

                    <div class="hidden sm:flex items-center gap-1 text-secondary-600 font-semibold text-sm group-hover:text-secondary-700 transition-colors whitespace-nowrap pl-2">
                         <span>Read</span>
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                         </svg>
                    </div>
                </div>
            </a>
          `
          container.appendChild(article)
        })

        if (allPages.length > visibleCount) {
          loadMoreContainer.classList.remove('hidden')
          loadMoreBtn.textContent = `Show More`
        } else {
          loadMoreContainer.classList.add('hidden')
        }
      }

      loadMoreBtn.addEventListener('click', () => {
        visibleCount += INCREMENT
        render()
      })

      init()
    </script>
  </body>
</html>

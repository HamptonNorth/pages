<!doctype html>
<!-- version 14.6 Claude Opus 4.5 -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/output.css" />
    <link rel="stylesheet" href="/styles/rm.css" />
    <script type="module" src="/components/client-components.js"></script>
    <rm-head page-title="Pages"></rm-head>
  </head>
  <body class="bg-primary-50">
    <rm-default-container>
      <rm-nav-header class="block"></rm-nav-header>
      <main class="mt-4 w-full">
        <article>
          <div class="mx-auto max-w-3xl px-4">
            <div
              id="category-title"
              class="text-primary-800 mt-2 text-3xl font-bold tracking-tight capitalize"
            >
              Loading...
            </div>
            <div class="text-primary-500 mt-2 mb-6 text-sm">
              Browse our latest articles and updates
            </div>
          </div>
          <section>
            <div id="status-container" class="mx-auto mb-4 hidden max-w-3xl px-4"></div>
            <div id="pages-container" class="mx-auto flex max-w-3xl flex-col gap-3 px-4"></div>
            <div
              id="load-more-container"
              class="mx-auto mt-6 mb-8 hidden max-w-3xl px-4 text-center"
            >
              <rm-button id="btn-load-more" sm secondary>Show More</rm-button>
            </div>
          </section>
        </article>
      </main>
      <rm-footer></rm-footer>
    </rm-default-container>
    <script>
      // State variables
      var allPages = []
      var visibleCount = 15
      var INCREMENT = 15

      // Extract category from URL path
      var pathParts = window.location.pathname.split('/').filter(function (p) {
        return p
      })
      var category = pathParts[1] || ''

      /**
       * Format ISO 8601 date string to readable format
       * Handles: 2025-12-12T10:35:00-00:00 or 2025-12-12T00:00:00
       */
      function formatDate(isoString) {
        if (!isoString) return ''
        try {
          var d = new Date(isoString)
          if (isNaN(d.getTime())) return ''
          return d.toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
          })
        } catch (e) {
          return ''
        }
      }

      /**
       * Parse date string to timestamp for sorting
       * Returns 0 if date is invalid (sorts to end)
       */
      function getDateTimestamp(dateStr) {
        if (!dateStr) return 0
        try {
          var ts = new Date(dateStr).getTime()
          return isNaN(ts) ? 0 : ts
        } catch (e) {
          return 0
        }
      }

      /**
       * Check if a page is marked as sticky
       * Front matter: sticky: true (or yes, y, 1)
       */
      function isSticky(page) {
        if (!page || !page.sticky) return false
        var val = String(page.sticky).toLowerCase().trim()
        return val === 'true' || val === 'yes' || val === 'y' || val === '1'
      }

      /**
       * Sort pages:
       * 1. Sticky pages first (sorted by created date, newest first)
       * 2. Non-sticky pages second (sorted by created date, newest first)
       */
      function sortPages(pages) {
        if (!Array.isArray(pages)) return []

        // Create a copy to avoid mutating original
        var sorted = pages.slice()

        sorted.sort(function (a, b) {
          var aSticky = isSticky(a)
          var bSticky = isSticky(b)

          // Sticky pages come first
          if (aSticky && !bSticky) return -1
          if (!aSticky && bSticky) return 1

          // Within same group, sort by created date (newest first)
          var dateA = getDateTimestamp(a.created)
          var dateB = getDateTimestamp(b.created)
          return dateB - dateA
        })

        return sorted
      }

      /**
       * Initialize the page list
       */
      function init() {
        if (!category) {
          document.getElementById('category-title').textContent = 'Category Not Found'
          return
        }

        // Set category title
        document.getElementById('category-title').textContent =
          category.charAt(0).toUpperCase() + category.slice(1)

        fetch('/api/pages/list/' + category)
          .then(function (res) {
            if (!res.ok) throw new Error('Failed to fetch')
            return res.json()
          })
          .then(function (data) {
            allPages = data.pages || []

            // Sort: sticky first, then by date within each group
            allPages = sortPages(allPages)

            render()
          })
          .catch(function (err) {
            console.error('Error loading pages:', err)
            document.getElementById('pages-container').innerHTML =
              '<p class="text-red-600">Failed to load pages. Please try again.</p>'
          })
      }

      /**
       * Render the page list
       */
      function render() {
        var container = document.getElementById('pages-container')
        var loadMoreContainer = document.getElementById('load-more-container')

        container.innerHTML = ''

        // Show message if no pages
        if (!allPages || allPages.length === 0) {
          container.innerHTML = '<p class="text-primary-500">No pages found in this category.</p>'
          loadMoreContainer.classList.add('hidden')
          return
        }

        // Render visible pages
        var pagesToShow = allPages.slice(0, visibleCount)

        pagesToShow.forEach(function (page) {
          var article = document.createElement('div')
          article.className =
            'group relative bg-white p-4 rounded-md border border-primary-100 shadow-sm hover:shadow-md transition-all'

          // Private badge
          var privateBadge = page.private
            ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 border border-amber-200">Private</span>'
            : ''

          // Sticky indicator (pin icon)
          var stickyBadge = isSticky(page)
            ? '<span class="mr-2 text-primary-500" title="Pinned"><svg class="w-4 h-4 inline" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a3 3 0 015-2.236A3 3 0 0114.83 6H16a2 2 0 110 4h-5V9a1 1 0 10-2 0v1H4a2 2 0 110-4h1.17C5.06 5.687 5 5.35 5 5zm4 1V5a1 1 0 10-2 0v1h2zm3 0a1 1 0 10-2 0v1h2V6z" clip-rule="evenodd"/><path d="M9 11H3v5a2 2 0 002 2h4v-7zm2 7h4a2 2 0 002-2v-5h-6v7z"/></svg></span>'
            : ''

          // Format date
          var dateStr = formatDate(page.created)
          var dateHtml = dateStr
            ? '<span class="text-xs text-primary-400 font-mono">' + dateStr + '</span>'
            : ''

          article.innerHTML =
            '<a href="/pages/' +
            category +
            '/' +
            page.slug +
            '" class="block">' +
            '<div class="flex justify-between items-center gap-4">' +
            '<div class="flex-grow min-w-0">' +
            '<h2 class="text-lg font-bold text-primary-800 group-hover:text-primary-600 truncate leading-tight flex items-center">' +
            stickyBadge +
            (page.title || 'Untitled') +
            privateBadge +
            '</h2>' +
            '<p class="text-sm text-primary-600 mt-1 line-clamp-2">' +
            (page.summary || '') +
            '</p>' +
            '<div class="mt-2 hidden">' +
            dateHtml +
            ' use to debug date sort!</div>' +
            '</div>' +
            '<div class="hidden sm:flex items-center gap-1 text-secondary-600 font-semibold text-sm group-hover:text-secondary-700 transition-colors whitespace-nowrap pl-2">' +
            '<span>Read</span>' +
            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>' +
            '</svg>' +
            '</div>' +
            '</div>' +
            '</a>'

          container.appendChild(article)
        })

        // Show/hide load more button
        if (allPages.length > visibleCount) {
          loadMoreContainer.classList.remove('hidden')
        } else {
          loadMoreContainer.classList.add('hidden')
        }
      }

      // Load more button handler
      document.getElementById('btn-load-more').addEventListener('click', function () {
        visibleCount += INCREMENT
        render()
      })

      // Initialize on page load
      init()
    </script>
  </body>
</html>

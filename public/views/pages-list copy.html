<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/output.css" />
    <link rel="stylesheet" href="/styles/rm.css" />
    <script type="module" src="/components/client-components.js"></script>
    <rm-head page-title="Pages"></rm-head>
  </head>
  <body class="bg-primary-50">
    <rm-default-container>
      <rm-nav-header class="block"></rm-nav-header>

      <main class="mt-4 w-full">
        <article>
          <div
            id="category-title"
            class="text-primary-700 mt-2 ml-8 text-4xl font-semibold capitalize"
          >
            Loading...
          </div>

          <section>
            <div class="text-primary-600 mx-8 mt-8 mb-4 text-xl">
              Browse our latest articles and updates
            </div>

            <div id="status-container" class="mx-8 mb-4 hidden"></div>

            <div id="pages-container" class="mx-8 flex flex-col gap-6">
              <div class="flex animate-pulse flex-col gap-2">
                <div class="bg-primary-100 h-6 w-1/3 rounded"></div>
                <div class="bg-primary-50 h-4 w-2/3 rounded"></div>
              </div>
            </div>

            <div id="load-more-container" class="mx-8 mt-8 mb-8 hidden">
              <rm-button id="btn-load-more" secondary>Show More</rm-button>
            </div>
          </section>
        </article>
      </main>

      <rm-footer></rm-footer>
    </rm-default-container>

    <script>
      // State
      let allPages = []
      let visibleCount = 25
      const INCREMENT = 25

      // Get category from URL (e.g., /pages/technical -> technical)
      const pathParts = window.location.pathname.split('/').filter((p) => p)
      // pathParts[0] is 'pages', pathParts[1] is the category
      const category = pathParts.length >= 2 ? pathParts[1] : ''

      // DOM Elements
      const container = document.getElementById('pages-container')
      const loadMoreBtn = document.getElementById('btn-load-more')
      const loadMoreContainer = document.getElementById('load-more-container')
      const titleEl = document.getElementById('category-title')
      const statusEl = document.getElementById('status-container')
      const headEl = document.querySelector('rm-head')

      async function init() {
        if (!category) {
          titleEl.textContent = 'Category Not Found'
          showStatus('Invalid URL structure.', 'error')
          container.innerHTML = ''
          return
        }

        // Update Page Title and Header
        const displayCategory = category.charAt(0).toUpperCase() + category.slice(1)
        titleEl.textContent = displayCategory
        if (headEl) headEl.setAttribute('page-title', `${displayCategory} - Pages`)

        try {
          const res = await fetch(`/api/pages/list/${category}`)

          if (!res.ok) {
            throw new Error('Failed to fetch pages')
          }

          const data = await res.json()
          allPages = data.pages || []

          render()
        } catch (err) {
          console.error(err)
          container.innerHTML = ''
          showStatus('Unable to load pages. Please try again later.', 'error')
        }
      }

      function formatDate(isoString) {
        if (!isoString) return ''
        const d = new Date(isoString)
        return d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })
      }

      function showStatus(msg, type) {
        statusEl.classList.remove('hidden')
        statusEl.innerHTML = `<div class="p-4 rounded ${type === 'error' ? 'bg-red-50 text-red-700' : 'bg-primary-100 text-primary-700'}">${msg}</div>`
      }

      function render() {
        container.innerHTML = ''

        if (allPages.length === 0) {
          showStatus('No published pages found in this category.', 'info')
          return
        }

        const toShow = allPages.slice(0, visibleCount)

        toShow.forEach((page) => {
          // Determine Link URL: /pages/category/slug
          const linkUrl = `/pages/${category}/${page.slug}`

          // Create the card/entry structure
          const article = document.createElement('div')
          // Using a clean white card look similar to standard app lists
          article.className =
            'bg-white p-6 rounded-lg shadow-sm border border-primary-100 hover:shadow-md transition-shadow duration-200 flex flex-col gap-2'

          let metaBadges = ''

          // Date Badge
          if (page.created) {
            metaBadges += `<span class="text-xs text-primary-400 font-mono flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                      ${formatDate(page.created)}
                   </span>`
          }

          // Private Badge
          if (page.private) {
            metaBadges += `<span class="ml-3 text-xs bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full font-medium border border-amber-200">Private</span>`
          }

          article.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between">
                        <a href="${linkUrl}" class="group">
                            <h2 class="text-xl font-bold text-primary-800 group-hover:text-primary-600 transition-colors">${page.title || 'Untitled'}</h2>
                        </a>
                        <div class="mt-1 sm:mt-0 flex items-center">
                            ${metaBadges}
                        </div>
                    </div>

                    <p class="text-primary-600 line-clamp-3 leading-relaxed">
                        ${page.summary || 'No summary available.'}
                    </p>

                    <div class="pt-2">
                        <a href="${linkUrl}" class="text-sm font-semibold text-secondary-600 hover:text-secondary-700 hover:underline inline-flex items-center gap-1">
                            Read article
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </a>
                    </div>
                `
          container.appendChild(article)
        })

        // Handle Load More visibility
        if (allPages.length > visibleCount) {
          loadMoreContainer.classList.remove('hidden')
          // Update the custom element label if supported, or textContent fallback
          loadMoreBtn.textContent = `Show More (${allPages.length - visibleCount} remaining)`
        } else {
          loadMoreContainer.classList.add('hidden')
        }
      }

      loadMoreBtn.addEventListener('click', () => {
        visibleCount += INCREMENT
        render()
      })

      init()
    </script>
  </body>
</html>
